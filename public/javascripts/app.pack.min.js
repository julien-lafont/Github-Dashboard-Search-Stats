(function(){window.zen={};zen.view={};zen.model={};zen.util={};zen.results=[];zen.store=new Lawnchair("zen",$.noop);zen.config={pagination_max:10,preload:true}})();$(function(){$("#search").zenSearch({url:"/client/search/"});$("#search select").chosen({allow_single_deselect:true});$().UItoTop({easingType:"easeOutQuart"});$("#offlineMarker").offline()});zen.model.Repo=Backbone.Model.extend({url:function url(){return"/api/v1/repository/"+this.get("user")+"/"+this.get("repo")+"/detail"},toPresenter:function toPresenter(){var a=this.toJSON();a.id=a.owner.login+"-"+a.name;return a},validate:function validate(a){var b=_.isUndefined(a.error)&&!_.isUndefined(a.description)&&!_.isEmpty(a.name)&&!_.isUndefined(a.owner);if(!b){return"invalid"}}});zen.model.Repo.load=function load(d,b,c){var a=d.user+"/"+d.repo;zen.store.get(a,function(f){if(f){b(new zen.model.Repo(f))}else{if(!zen.util.isOnline()){return}var e=new zen.model.Repo(d);e.fetch({success:function(){zen.store.save(e.toJSON());b(e)},error:function(){c("This repository seems to be invalid !")}})}})};zen.model.Repo.loadAndShow=function loadAndShowResume(a){zen.model.Repo.load({user:a.get("username"),repo:a.get("name")},function(b){new zen.view.RepoResumeView({model:b}).render()})};zen.model.RepoSet=Backbone.Collection.extend({model:zen.model.Repo,url:function url(){return"/api/v1/repository/search/"+this.query+"/"+this.page},initialize:function RepoSet(a){this.query=a.query;this.page=a.page}});zen.model.RepoSet.load=function load(c,b,d){var a=c+"/"+b;zen.store.get(a,function(e){if(e){d(new zen.model.RepoSet(e))}else{if(!zen.util.isOnline()){return}var f=new zen.model.RepoSet({query:c,page:b});f.fetch({success:function(g){var h=f.toJSON();h.key=a;zen.store.save(h);d(f)}})}})};zen.view.RepoResumeView=Backbone.View.extend({el:"#results",model:zen.model.Repo,initialize:function initialize(){_.bindAll(this,"render","showDetail","showTimeline","closeDetail");this.tpl=Handlebars.compile($("#template-repo-resume").html());this.model.bind("change",this.render);if(this.model.rendered){this.render()}},render:function render(){this.model.rendered=true;var b=this.model.toPresenter();this.$el.append(this.tpl(b));this.$el.find(".waiting").hide();var a=$("#repo-resume-"+b.id).fadeIn(1000);this.initEvents(a);return this},initEvents:function initEvents(a){a.find("a.showDetail").on("click",this.showDetail);a.find("a.showTimeline").on("click",this.showTimeline);a.find("a.closeDetail").on("click",this.closeDetail)},showDetail:function showDetail(){var a=$("#repo-resume-"+this.model.toPresenter().id+" .stats").empty();new zen.view.RepoStatsView({el:a,model:this.model,fromList:true}).render()},showTimeline:function showTimeline(){var a=$("#repo-resume-"+this.model.toPresenter().id+" .stats").empty();new zen.view.RepoTimelineView({el:a,model:this.model,fromList:true}).render()},closeDetail:function closeDetail(){var a=$("#repo-resume-"+this.model.toPresenter().id);a.find(".stats").empty();a.find("a.closeDetail").hide();a.find("a.showDetail, a.showTimeline").show()}});zen.view.RepoStatsView=Backbone.View.extend({model:zen.model.Repo,initialize:function initialize(){_.bindAll(this,"render","showImpact","showCommiters","showActivity","showWatchers","showLanguages","loadStats","fetchGeolocInformations","showGeolocCommiters");this.infos=this.model.toPresenter();zen.router.navigate("client/"+this.infos.owner.login+"/"+this.infos.name);this.tpl=Handlebars.compile($("#template-repo-stats").html())},render:function render(){this.$el.html(this.tpl());var a=$("#repo-resume-"+this.infos.id);a.find(".showDetail").hide();a.find(".showTimeline").show();if($(".result").length>1){a.find(".closeDetail").show()}this.loadStats();return this},loadStats:function loadStats(){var a=this.infos.owner.login;var b=this.infos.name;zen.util.getJSONCache("/api/v1/repository/"+a+"/"+b+"/contributors",this.showCommiters);zen.util.getJSONCache("/api/v1/repository/"+a+"/"+b+"/contributors",this.fetchGeolocInformations);zen.util.getJSONCache("/api/v1/repository/"+a+"/"+b+"/watchers",this.showWatchers);zen.util.getJSONCache("/api/v1/repository/"+a+"/"+b+"/languages",this.showLanguages);zen.util.getJSONCache("/api/v1/stats/"+a+"/"+b+"/impact",this.showImpact);zen.util.getJSONCache("/api/v1/stats/"+a+"/"+b+"/timeline",this.showActivity)},fetchGeolocInformations:function fetchGeolocInformations(c){var d={};var b=this.showGeolocCommiters;var a=Math.min(c.length,200)-1;_(c).first(200).forEach(function(f,e){zen.util.getJSONCache("/api/v1/user/"+f.login+"/geolocalisation",function(g){if(g){d[g.countrycode]=(d[g.countrycode]||0)+1}if(e==a){_.delay(function(){b(d)},1000)}})})},showCommiters:function showCommiters(b){var a=this.$el.find(".commiters").empty().hide();var c=Handlebars.compile($("#template-stats-commiters").html());a.append(c({items:_(b).first(100)}));a.fadeIn(1000);zen.util.scrollRight(a)},showWatchers:function showWatchers(b){var a=this.$el.find(".watchers").empty().hide();var c=Handlebars.compile($("#template-stats-commiters").html());a.append(c({items:_(b).first(100)}));a.fadeIn(1000);zen.util.scrollLeft(a)},showActivity:function showTimeline(c){var a=this.$el.find(".timeline").empty().hide();var d=new google.visualization.DataTable();d.addColumn("string","Date");d.addColumn("number","Commits");_(c).forEach(function(e){d.addRow([e.date,e.nb])});var b=new google.visualization.AreaChart(a.get(0));b.draw(d,{width:640,height:300,legend:{position:"none"}});a.fadeIn(1000)},showImpact:function showImpact(b){var a=this.$el.find(".impact").empty().hide();var d=new google.visualization.DataTable();d.addColumn("string","Contributor");d.addColumn("number","Impact");_(b).forEach(function(e){d.addRow([e.author.login,e.score])});var c=new google.visualization.PieChart(a.get(0));c.draw(d,{width:640,height:300,chartArea:{height:300}});a.fadeIn(1000)},showLanguages:function showLanguages(d){var a=this.$el.find(".languages").empty().hide();var c=new google.visualization.DataTable();c.addColumn("string","Language");c.addColumn("number","Lines");_(d).forEach(function(f,e){c.addRow([e,f])});var b=new google.visualization.PieChart(a.get(0));b.draw(c);a.fadeIn(1000)},showGeolocCommiters:function showGeolocCommiters(c){var a=this.$el.find(".geoloc").empty().hide();var d=new google.visualization.DataTable();d.addColumn("string","Country");d.addColumn("number","Commiters");_(c).forEach(function(f,e){d.addRow([e,f])});var b=new google.visualization.GeoChart(a.get(0));b.draw(d,{});a.fadeIn(1000)}});zen.view.RepoTimelineView=Backbone.View.extend({model:zen.model.Repo,initialize:function initialize(){_.bindAll(this,"render","showTimeline");this.infos=this.model.toPresenter();zen.router.navigate("client/"+this.infos.owner.login+"/"+this.infos.name+"/commits")},render:function render(){this.tpl=Handlebars.compile($("#template-repo-timeline").html());this.$el.html(this.tpl());var a=$("#repo-resume-"+this.infos.id);a.find(".showDetail").show();a.find(".showTimeline").hide();if($(".result").length>1){a.find(".closeDetail").show()}zen.util.getJSONCache("/api/v1/repository/"+this.infos.owner.login+"/"+this.infos.name+"/commits",this.showTimeline)},showTimeline:function showTimeline(c){var b=this.$el.find(".timeline").empty().hide();var a=Handlebars.compile($("#template-commit").html());c=_(c).map(_.bind(function(d){if(d.author.avatar==""){d.author.avatar=this.infos.owner.avatar}return d},this));b.append(a({items:c}));b.slideDown(1000)}});zen.view.SearchLayoutView=Backbone.View.extend({el:"#main_content",initialize:function initialize(){_.bindAll(this,"render");this.tpl=Handlebars.compile($("#template-layout-search").html())},render:function render(){this.$el.html(this.tpl());return this}});zen.view.SearchView=Backbone.View.extend({pagination:0,initialize:function initialize(){_.bindAll(this,"add");zen.results=[];this.pagination=zen.config.pagination_max;if(this.collection.length==0){$(".no-result").show();$(".waiting").hide()}else{this.collection.each(function(a){this.add(a)},this);zen.util.preloadNextRepos();$(window).scroll(zen.util.infiniteScroll)}},add:function add(a){if(--this.pagination>=0){zen.model.Repo.loadAndShow(a)}else{zen.results.push(a);zen.config.infiniteScrollOn=true}}});zen.view.ErrorView=Backbone.View.extend({el:"#main_content",initialize:function initialize(){_.bindAll(this,"render")},render:function render(){var a=this.options.msg||"Oops an error occurred";this.$el.html('<div class="error">'+a+"</div>").show();return this}});zen.util.infiniteScroll=function(){if(!zen.config.infiniteScrollOn){return}if(zen.util.isAtBottom(150)){if(zen.results.length==0){$(".no-more-results:hidden").fadeIn(1000)}else{zen.config.infiniteScrollOn=false;for(var a=0;a<zen.config.pagination_max&&zen.results.length>0;a++){zen.model.Repo.loadAndShow(zen.results.shift())}zen.util.preloadNextRepos();_.delay(function(){zen.config.infiniteScrollOn=true},500)}}};zen.util.preloadNextRepos=function(a,b){if(!zen.config.preload){return}_(zen.results).first(a||zen.config.pagination_max).forEach(function(c){_.delay(function(){zen.model.Repo.load({user:c.get("username"),repo:c.get("name")},$.noop)},b||1000)})};zen.util.isOnline=function(){return !("onLine" in navigator)||navigator.onLine};zen.util.getJSONCache=function(b,c,a){zen.store.get(b,function(d){if(d){c(d.data)}else{$.ajax(b,{dataType:"json",success:function(e){zen.store.save({key:b,data:e});c(e)},error:(a||$.noop)()})}})};zen.util.scrollLeft=function(a){var b=a.get(0);a.on("mouseover",function(){$(this).addClass("hover")});a.on("mouseleave",function(){$(this).removeClass("hover")});setInterval(function(){if(!a.hasClass("hover")&&b.scrollLeft<b.scrollWidth-b.clientWidth){b.scrollLeft+=2}},50)};zen.util.scrollRight=function(a){var b=a.get(0);a.on("mouseover",function(){$(this).addClass("hover")});a.on("mouseleave",function(){$(this).removeClass("hover")});b.scrollLeft=b.scrollWidth-b.clientWidth;setInterval(function(){if(!a.hasClass("hover")&&0<b.scrollWidth-b.clientWidth){b.scrollLeft-=2}},50)};zen.util.isAtBottom=function(a){return $(window).scrollTop()>=$(document).height()-$(window).height()-a};zen.Router=Backbone.Router.extend({routes:{"client/search/:query":"search","client/:user/:repo":"detail","client/:user/:repo/commits":"commits"},search:function search(a){new zen.view.SearchLayoutView().render();var b=zen.model.RepoSet.load(a,1,function(c){new zen.view.SearchView({collection:c})})},detail:function detail(a,b){var c={user:a,repo:b};var b=zen.model.Repo.load(c,function(d){new zen.view.RepoResumeView({model:d,el:$("#main_content").empty()}).render();new zen.view.RepoStatsView({model:d,el:$("#main_content .stats:first")}).render()},function(d){new zen.view.ErrorView({msg:d}).render()})},commits:function commits(a,b){var c={user:a,repo:b};var b=zen.model.Repo.load(c,function(d){new zen.view.RepoResumeView({model:d,el:$("#main_content").empty()}).render();new zen.view.RepoTimelineView({model:d,el:$("#main_content .stats:first")}).render()},function(d){new zen.view.ErrorView({msg:d}).render()})}});$(function(){zen.router=new zen.Router();Backbone.history.start({pushState:true})});